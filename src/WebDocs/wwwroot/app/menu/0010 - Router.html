<!DOCTYPE html>
<script src="/drapo.js"></script>
<div>
    <div>
        <h2>Router</h2>
        <p>Drapo provides a simple way to create routes in your application. To do this, you must have a default <code>index.html</code> file in the root folder of your application.</p>
        <p>This file must have all sectors properly configured.</p>
        <p><strong>Note:</strong> The index.html can be dynamically generated using the <code>RouteIndexEvent</code> delegate. This is useful for multi-tenant applications where different tenants need different index content. See the <a href="#" d-on-click="ApplyRoute(/doc/0002%20-%20Configuration)">Configuration</a> documentation for more details.</p>
        <p>You can check a sample <code>index.html</code> in the link <a href="https://github.com/spadrapo/docs/blob/master/src/WebDocs/wwwroot/index.html">below</a>:</p>
        <d-code>
            https://github.com/spadrapo/docs/blob/master/src/WebDocs/wwwroot/index.html
        </d-code>
        <p>You can configure the routes using the Drapo config class file. Each route must have at least a regular expression and an expression to execute. You can also configure expressions to run before and after the route is loaded.</p>
        <p><a href="https://github.com/spadrapo/docs/blob/master/src/WebDocs/Startup.cs">Here</a> you can see a sample configuration:</p>
        <d-code>
            options.Config.CreateRoute("^/function/(?<id>\\w+)$", "ClearSector(content);UpdateSector(content,~/app/shared/function.html)");
            options.Config.CreateRoute("^/doc/(?<id>\\w+)$", "ClearSector(content);UpdateSector(content,~/app/shared/doc.html)");
            options.Config.CreateRoute("^/$", "UpdateSector(content,~/app/menu/0000%20-%20Drapo.html)");
        </d-code>
        <p>In this example, we have three routes. The first one is used for functions, the second for documentation or menu options, and the third for the default route.</p>
        <p>This sample configuration is the same one currently used in this documentation.</p>
        <p>When the browser URL path changes, Drapo will try to find the best matching route.</p>
        <p>Once it finds a matching route, Drapo will load the default <code>index.html</code> (or dynamically generate it via <code>RouteIndexEvent</code> if configured) and execute the expression defined in the route.</p>
        <br />
        <h3>Rejected Routes</h3>
        <p>Drapo also supports <strong>rejected routes</strong>—routes that match a pattern but intentionally halt route processing without executing any action or checking subsequent routes. This is useful for blocking access to specific paths.</p>
        <p>When a rejected route matches the current path, Drapo will:</p>
        <ul>
            <li>Stop processing immediately</li>
            <li>Not execute any expression</li>
            <li>Not check any subsequent routes in the list</li>
        </ul>
        <p>You can create a rejected route using the <code>CreateRejectedRoute</code> method with a regular expression pattern:</p>
        <d-code>
            options.Config.CreateRejectedRoute("^/admin/.*$");
        </d-code>
        <p>Here's a practical example showing how rejected routes can be used to block specific paths while allowing others:</p>
        <d-code>
            // Block access to admin paths—stops processing, doesn't continue to other routes
            options.Config.CreateRejectedRoute("^/admin/.*$");

            // Block specific subdirectories under /allowed
            options.Config.CreateRejectedRoute("^/allowed/deny.*$");

            // Normal route continues to work as expected for /allowed paths
            options.Config.CreateRoute("^/allowed/.*$", "UpdateSector(content,~/DrapoPages/Public.html)");

            // Normal public route
            options.Config.CreateRoute("^/public/.*$", "UpdateSector(content,~/DrapoPages/Public.html)");
        </d-code>
        <p><strong>Important:</strong> Route order matters! Place rejected routes before normal routes that might also match the same path pattern. In the example above, <code>^/allowed/deny.*$</code> is placed before <code>^/allowed/.*$</code> to ensure deny paths are rejected first.</p>
        <br />
        <h3>Dynamic Routes</h3>
        <p>Drapo now supports <strong>dynamic routes</strong>—routes that are determined at runtime based on the HTTP request context. This is particularly useful for multi-tenant applications where different tenants may have different routing configurations.</p>
        <p>With dynamic routes, you can:</p>
        <ul>
            <li>Configure routes per request based on tenant, user, or other context</li>
            <li>Support multi-tenant environments with tenant-specific routes</li>
            <li>Determine routes based on HTTP headers, subdomains, query parameters, or authentication</li>
            <li>Override static routes with dynamic routes (dynamic routes take precedence)</li>
        </ul>
        <p>To configure dynamic routes, register a <code>RouteEvent</code> delegate in your <code>Startup.cs</code> file:</p>
        <d-code>
            private void ConfigureDrapo(IWebHostEnvironment env, DrapoMiddlewareOptions options)
            {
                // Configure static routes
                options.Config.CreateRoute("^/$", "UpdateSector(content,~/app/menu/0000%20-%20Drapo.html)");
                
                // Register dynamic route delegate
                options.RouteEvent += DynamicRoutes;
            }

            private async Task&lt;List&lt;DrapoRoute&gt;&gt; DynamicRoutes(HttpContext context)
            {
                // Get tenant identifier from query string, header, or other source
                string tenant = context.Request.Query["tenant"].ToString();
                
                List&lt;DrapoRoute&gt; routes = new List&lt;DrapoRoute&gt;();
                
                if (!string.IsNullOrEmpty(tenant))
                {
                    if (tenant.Equals("tenant1", StringComparison.OrdinalIgnoreCase))
                    {
                        // Routes specific to Tenant 1
                        routes.Add(new DrapoRoute
                        {
                            Uri = "^/home$",
                            Expression = "UpdateSector(content,~/DrapoPages/Tenant1Home.html)"
                        });
                    }
                    else if (tenant.Equals("tenant2", StringComparison.OrdinalIgnoreCase))
                    {
                        // Routes specific to Tenant 2
                        routes.Add(new DrapoRoute
                        {
                            Uri = "^/home$",
                            Expression = "UpdateSector(content,~/DrapoPages/Tenant2Home.html)"
                        });
                    }
                }
                
                return await Task.FromResult(routes);
            }
        </d-code>
        <p><strong>Key Features:</strong></p>
        <ul>
            <li><strong>Context-Based:</strong> Routes can be determined based on any aspect of the HttpContext (headers, subdomain, user claims, query parameters, cookies)</li>
            <li><strong>Priority:</strong> Dynamic routes are checked first and take precedence over static routes</li>
            <li><strong>Backward Compatible:</strong> Static routes continue to work unchanged</li>
            <li><strong>Multi-Tenant Support:</strong> Different tenants can have completely different route configurations</li>
        </ul>
        <p><strong>Common Use Cases:</strong></p>
        <ul>
            <li><strong>Header-Based Routing:</strong> Use <code>context.Request.Headers["X-Tenant"]</code> to determine tenant</li>
            <li><strong>Subdomain-Based Routing:</strong> Extract tenant from <code>context.Request.Host.Host</code></li>
            <li><strong>User Role-Based Routing:</strong> Use <code>context.User.IsInRole("Admin")</code> for role-specific routes</li>
            <li><strong>Query String-Based Routing:</strong> Use <code>context.Request.Query["tenant"]</code> for testing or simple scenarios</li>
        </ul>
        <p>For more detailed examples and configuration options, see the <a href="#" d-on-click="ApplyRoute(/doc/0001%20-%20Installation/0002%20-%20Configuration)">Configuration</a> documentation.</p>
        <br />
        <p>To change the current route in the application, you can use the <code>ApplyRoute</code> function. Below is an example of how to use it:</p>
        <d-sample>
            <span d-on-click="ApplyRoute(/function/ApplyRoute)">Click here to route the application to ApplyRoute</span>
        </d-sample>
    </div>
</div>
